user  nginx;
# Log to stderr so it's guaranteed to show in Docker logs
error_log  /dev/stderr warn;

events {
    worker_connections 1024;
}

stream {
    resolver 8.8.8.8;

    map $ssl_preread_server_name $backend_name {
        "dns.local"        127.0.0.1:8443;
        default            $ssl_preread_server_name:443;
    }

    server {
        listen 443;
        proxy_pass $backend_name;
        ssl_preread on;
    }
}

http {
    include       mime.types;
    # Log to stdout for Docker
    access_log    /dev/stdout;
    
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:100m max_size=10g 
                     inactive=60m use_temp_path=off;

    # Extract Host from X-Target header or use the Host header
    map $http_x_target $target_host {
        "~^https?://(?<h>[^/:]+)" $h;
        default $http_host;
    }

    # PORT 80: Transparent / App Proxy
    server {
        listen 80;
        resolver 8.8.8.8 valid=30s;

        # Serve the Root CA at /ca.pem
        location /ca.pem {
            alias /etc/nginx/ssl/rootCA.pem;
            default_type application/x-x509-ca-cert;
            add_header Content-Disposition 'attachment; filename="montycache.pem"';
        }

        proxy_intercept_errors on;
        recursive_error_pages on;

        set $target_https "https://$host$request_uri";
        set $target_http  "http://$host$request_uri";

        if ($http_x_target ~* "^https?://") {
            set $target_https $http_x_target;
            set $target_http  $http_x_target;
        }

        location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|otf)$ {
            error_page 502 503 504 = @asset_http_fallback;
            proxy_pass $target_https;
            proxy_set_header Host $target_host;
            proxy_ssl_server_name on;
            
            proxy_cache my_cache;
            proxy_cache_min_uses 3;
            proxy_cache_valid 200 302 60m;
            add_header X-Cache-Status $upstream_cache_status;
            add_header X-Proxy-Target $target_https;
        }

        location / {
            error_page 502 503 504 = @base_http_fallback;
            proxy_pass $target_https;
            proxy_set_header Host $target_host;
            proxy_ssl_server_name on;
            proxy_cache off;
            add_header X-Cache-Status "BYPASS-STATIC-ONLY";
            add_header X-Proxy-Target $target_https;
        }

        location @asset_http_fallback {
            proxy_pass $target_http;
            proxy_set_header Host $target_host;
            proxy_cache my_cache;
            proxy_cache_min_uses 3;
            proxy_cache_valid 200 302 60m;
            add_header X-Cache-Status $upstream_cache_status;
            add_header X-Proxy-Protocol "HTTP-FALLBACK";
        }

        location @base_http_fallback {
            proxy_pass $target_http;
            proxy_set_header Host $target_host;
            proxy_cache off;
            add_header X-Cache-Status "BYPASS-STATIC-ONLY";
        }
    }

    # PORT 8443: SSL Termination
    server {
        listen 8443 ssl;
        resolver 8.8.8.8;

        ssl_certificate     /etc/nginx/ssl/sites.pem;
        ssl_certificate_key /etc/nginx/ssl/sites.key;
        ssl_protocols TLSv1.2 TLSv1.3;

        location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|otf)$ {
            proxy_pass https://$host$request_uri;
            proxy_set_header Host $host;
            proxy_ssl_server_name on;
            proxy_cache my_cache;
            proxy_cache_min_uses 3;
            proxy_cache_valid 200 302 60m;
            add_header X-Cache-Status $upstream_cache_status;
            add_header X-Proxy-Mode "MITM-HTTPS";
        }

        location / {
            proxy_pass https://$host$request_uri;
            proxy_set_header Host $host;
            proxy_ssl_server_name on;
            proxy_cache off;
            add_header X-Cache-Status "BYPASS-STATIC-ONLY";
        }
    }

    # PORT 3128: Forward Proxy
    server {
        listen 3128;
        resolver 8.8.8.8;
        proxy_connect;
        proxy_connect_allow            443 563;
        proxy_connect_connect_timeout  10s;

        location / {
            proxy_pass $scheme://$http_host$request_uri;
            proxy_set_header Host $http_host;
            
            location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|otf)$ {
                proxy_pass $scheme://$http_host$request_uri;
                proxy_set_header Host $http_host;
                proxy_cache my_cache;
                proxy_cache_min_uses 3;
                proxy_cache_valid 200 302 60m;
                add_header X-Cache-Status $upstream_cache_status;
            }
        }
    }
}
