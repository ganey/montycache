user root;
error_log /var/log/nginx/error.log warn;

events {
    worker_connections 2048;
}

stream {
    resolver 8.8.8.8;

    map $ssl_preread_server_name $backend_name {
        "dns.local"        127.0.0.1:8443;
        default            $ssl_preread_server_name:443;
    }

    server {
        listen 443;
        proxy_pass $backend_name;
        ssl_preread on;
    }
}

http {
    include       mime.types;
    default_type  text/plain;
    
    vhost_traffic_status_zone;
    vhost_traffic_status_filter_by_set_key $upstream_cache_status cache_status;
    vhost_traffic_status_dump /var/cache/nginx/vts.db 60s;

    log_format proxy_log '$remote_addr - $remote_user [$time_local] '
                         '"$request" $status $body_bytes_sent '
                         'Cache: $upstream_cache_status Target: $target_https';

    access_log    /dev/stdout proxy_log;
    
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:100m max_size=10g 
                     inactive=60m use_temp_path=off;

    proxy_cache_key "$scheme$request_method$host$request_uri";

    map $http_x_target $target_host {
        "~^https?://(?<h>[^/:]+)" $h;
        default $http_host;
    }

    # PORT 80: Transparent / App Proxy (Default Gateway)
    server {
        listen 80 default_server;
        server_name _;
        resolver 8.8.8.8 valid=30s;

        location = /ca.pem {
            alias /etc/nginx/ssl/rootCA.pem;
            default_type application/x-x509-ca-cert;
            add_header Content-Disposition 'attachment; filename="montycache.pem"';
        }

        location /status {
            vhost_traffic_status_display;
            vhost_traffic_status_display_format html;
        }

        proxy_intercept_errors on;
        recursive_error_pages on;

        set $target_https "https://$host$request_uri";
        set $target_http  "http://$host$request_uri";

        if ($http_x_target ~* "^https?://") {
            set $target_https $http_x_target;
            set $target_http  $http_x_target;
        }

        location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|otf)$ {
            error_page 502 503 504 = @asset_http_fallback;
            
            proxy_hide_header Access-Control-Allow-Origin;
            proxy_hide_header Access-Control-Allow-Methods;
            proxy_hide_header Access-Control-Allow-Headers;
            proxy_hide_header Timing-Allow-Origin;
            
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "*" always;
            add_header Timing-Allow-Origin "*" always;

            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                add_header Access-Control-Max-Age 1728000 always;
                return 204;
            }

            proxy_pass $target_https;
            proxy_set_header Host $target_host;
            proxy_set_header User-Agent $http_user_agent;
            proxy_ssl_server_name on;
            
            proxy_cache my_cache;
            proxy_cache_min_uses __CACHE_MIN_USES__;
            proxy_cache_valid 200 302 __CACHE_DURATION__;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            add_header X-Cache-Status $upstream_cache_status always;
        }

        location / {
            error_page 502 503 504 = @base_http_fallback;
            proxy_pass $target_https;
            proxy_set_header Host $target_host;
            proxy_set_header User-Agent $http_user_agent;
            proxy_ssl_server_name on;
            proxy_cache off;
            add_header X-Cache-Status "BYPASS-STATIC-ONLY" always;
        }

        location @asset_http_fallback {
            proxy_pass $target_http;
            proxy_set_header Host $target_host;
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin "*" always;
            add_header X-Cache-Status $upstream_cache_status always;
        }

        location @base_http_fallback {
            proxy_pass $target_http;
            proxy_set_header Host $target_host;
            proxy_cache off;
        }
    }

    # PORT 8443: SSL Termination
    server {
        listen 8443 ssl default_server;
        server_name _;
        resolver 8.8.8.8;

        ssl_certificate     /etc/nginx/ssl/sites.pem;
        ssl_certificate_key /etc/nginx/ssl/sites.key;
        ssl_protocols TLSv1.2 TLSv1.3;

        location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|otf)$ {
            proxy_hide_header Access-Control-Allow-Origin;
            proxy_hide_header Access-Control-Allow-Methods;
            proxy_hide_header Access-Control-Allow-Headers;
            proxy_hide_header Timing-Allow-Origin;
            
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
            add_header Access-Control-Allow-Headers "*" always;
            add_header Timing-Allow-Origin "*" always;

            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "*" always;
                add_header Access-Control-Max-Age 1728000 always;
                return 204;
            }

            proxy_pass https://$host$request_uri;
            proxy_set_header Host $host;
            proxy_set_header User-Agent $http_user_agent;
            proxy_ssl_server_name on;
            
            proxy_cache my_cache;
            proxy_cache_min_uses __CACHE_MIN_USES__;
            proxy_cache_valid 200 302 __CACHE_DURATION__;
            proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
            
            add_header X-Cache-Status $upstream_cache_status always;
            add_header X-Proxy-Mode "MITM-HTTPS" always;
        }

        location / {
            proxy_pass https://$host$request_uri;
            proxy_set_header Host $host;
            proxy_set_header User-Agent $http_user_agent;
            proxy_ssl_server_name on;
            proxy_cache off;
            add_header X-Cache-Status "BYPASS-STATIC-ONLY" always;
        }
    }
}
