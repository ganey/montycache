# Force logs to stderr/stdout at the very top level
error_log /dev/stderr warn;

events {
    worker_connections 2048;
}

stream {
    resolver 192.168.3.77; # Placeholder - will be updated by entrypoint.sh

    map $ssl_preread_server_name $backend_name {
        "dns.local"        127.0.0.1:8443;
        default            $ssl_preread_server_name:443;
    }

    server {
        listen 443;
        proxy_pass $backend_name;
        ssl_preread on;
    }
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    
    # Force access logs to stdout
    access_log    /dev/stdout;
    
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:100m max_size=10g 
                     inactive=60m use_temp_path=off;

    map $http_x_target $target_host {
        "~^https?://(?<h>[^/:]+)" $h;
        default $http_host;
    }

    server {
        listen 80 default_server;
        server_name _;
        resolver 192.168.3.77 valid=30s; # Placeholder - will be updated by entrypoint.sh

        root /dev/null;

        location = /ca.pem {
            alias /etc/nginx/ssl/rootCA.pem;
            default_type application/x-x509-ca-cert;
            add_header Content-Disposition 'attachment; filename="montycache.pem"';
        }

        proxy_intercept_errors on;
        recursive_error_pages on;

        set $target_https "https://$host$request_uri";
        set $target_http  "http://$host$request_uri";

        if ($http_x_target ~* "^https?://") {
            set $target_https $http_x_target;
            set $target_http  $http_x_target;
        }

        location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|otf)$ {
            error_page 502 503 504 = @asset_http_fallback;
            proxy_pass $target_https;
            proxy_set_header Host $target_host;
            proxy_set_header User-Agent $http_user_agent;
            proxy_ssl_server_name on;
            
            proxy_cache my_cache;
            proxy_cache_min_uses 3;
            proxy_cache_valid 200 302 60m;
            add_header X-Cache-Status $upstream_cache_status;
            add_header X-Proxy-Target $target_https;
        }

        location / {
            error_page 502 503 504 = @base_http_fallback;
            proxy_pass $target_https;
            proxy_set_header Host $target_host;
            proxy_set_header User-Agent $http_user_agent;
            proxy_ssl_server_name on;
            proxy_cache off;
            add_header X-Cache-Status "BYPASS-STATIC-ONLY";
        }

        location @asset_http_fallback {
            proxy_pass $target_http;
            proxy_set_header Host $target_host;
            proxy_cache my_cache;
            proxy_cache_min_uses 3;
            proxy_cache_valid 200 302 60m;
            add_header X-Cache-Status $upstream_cache_status;
        }

        location @base_http_fallback {
            proxy_pass $target_http;
            proxy_set_header Host $target_host;
            proxy_cache off;
        }
    }

    server {
        listen 8443 ssl default_server;
        server_name _;
        resolver 192.168.3.77; # Placeholder - will be updated by entrypoint.sh
        root /dev/null;

        ssl_certificate     /etc/nginx/ssl/sites.pem;
        ssl_certificate_key /etc/nginx/ssl/sites.key;
        ssl_protocols TLSv1.2 TLSv1.3;

        location ~* \.(?:js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|otf)$ {
            proxy_pass https://$host$request_uri;
            proxy_set_header Host $host;
            proxy_set_header User-Agent $http_user_agent;
            proxy_ssl_server_name on;
            proxy_cache my_cache;
            proxy_cache_min_uses 3;
            proxy_cache_valid 200 302 60m;
            add_header X-Cache-Status $upstream_cache_status;
            add_header X-Proxy-Mode "MITM-HTTPS";
        }

        location / {
            proxy_pass https://$host$request_uri;
            proxy_set_header Host $host;
            proxy_set_header User-Agent $http_user_agent;
            proxy_ssl_server_name on;
            proxy_cache off;
        }
    }
}
